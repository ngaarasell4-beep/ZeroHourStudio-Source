# خطة الإصلاح والفحص الشاملة - ZeroHour Studio

## 1. ملخص المشاكل المبلّغ عنها

| المشكلة | الوصف | السبب التقني |
|--------|--------|---------------|
| **زر الفصيل** | الضغط عليه لا يظهر شيء | قائمة الفصائل تُملأ فقط بعد **تحميل المود الهدف** (تحميل الهدف). إذا لم يُحمَّل الهدف أو فشل الاكتشاف تبقى القائمة فارغة. في مدير القوالب القائمة كانت ثابتة وقد لا تظهر بشكل صحيح مع الواجهة العربية. |
| **زر القوالب** | لا يظهر شيء | قائمة القوالب تُحمّل من مجلد حفظ التطبيق. إذا لم يُحفظ أي قالب تبقى القائمة فارغة. زر الفصيل داخل النافذة يحتاج لملء ديناميكي من الفصائل المكتشفة. |
| **المراجع (خريطة المراجع)** | واجهة فارغة أو "0 مورد" | التحليل يعتمد على **ملفات INI مفكوكة** في المسار (مثل `Data\INI`). إذا كان المسار هو مجلد اللعبة الأصلي فقد تكون ملفات INI داخل أرشيفات .big فلا يجدها التحليل. |
| **التوازن** | 0% وقائمة فارغة و"ضعيف" | نفس السبب: التحليل يبحث عن ملفات .ini في المسار. عدم وجود وحدات للمقارنة يعطي 0% ولا تظهر تفاصيل. |
| **الفروقات** | قد تعمل أحياناً | تعتمد على مسار المصدر والهدف؛ إذا كان أحدهما غير محمّل أو خاطئ قد لا تظهر نتائج. |
| **تحويل فصيل الوحدة** | المنطقة السفلية فارغة | النافذة كانت تُفتح بمحتوى وحدة **فارغ** (نص INI لم يُمرَّر) فالمعاينة لا تعرض تغييرات. |
| **اللعبة لا تعمل بعد النقل** | تعطل اللعبة بعد نقل سلاح/وحدات | أسباب محتملة: مراجع مكسورة، ملفات INI تالفة، أزرار قيادة غير مكتملة، أصول (نماذج/أصوات) ناقصة، أو تعارض في الأسماء. |

---

## 2. الإصلاحات المطبّقة في الكود

### 2.1 زر الفصيل وقائمة الفصائل

- **لوحة الهدف (Porting Studio):** قائمة الفصائل `TargetFactionOptions` تُملأ عند استدعاء **تحميل الهدف** فقط.
  - **ما يجب فعله:** بعد اختيار مسار المود الهدف اضغط **«تحميل الهدف»** (أو «تحميل الهدف ⚡») حتى تظهر الفصائل والأماكن المتاحة.
- **مدير القوالب:** تم تحسين ملء قائمة الفصيل في نافذة القوالب (من الفصائل المحمّلة إن وُجدت، مع الاحتياط USA/China/GLA).

### 2.2 تحويل فصيل الوحدة – المنطقة الفارغة

- **السبب:** استدعاء `LoadUnit(unitName, "")` بمحتوى فارغ.
- **الإصلاح:** قراءة محتوى INI للوحدة من مسار المصدر وتمريره إلى النافذة حتى تعرض المعاينة والتغييرات.

### 2.3 التوازن والمراجع – واجهات فارغة

- **السبب:** الاعتماد على وجود مجلدات مثل `Data\INI` وملفات `.ini` **مفكوكة** في المسار. في اللعبة الأصلية غالباً تكون INI داخل .big.
- **الإصلاحات:**
  - عرض رسالة واضحة عند عدم وجود وحدات للمقارنة (التوازن) أو عند 0 مورد (المراجع).
  - توجيه المستخدم لاستخدام **مود مصدر** فيه ملفات INI مفكوكة (مود معدّل أو مود مع فك أرشيفات).

### 2.4 القوالب

- عرض رسالة «لا توجد قوالب محفوظة» عند فراغ القائمة.
- ملء قائمة الفصيل في مدير القوالب ديناميكياً عند فتح النافذة من الاستوديو (إن وُجدت فصائل).

---

## 3. توصيات الاستخدام لتجنب الواجهات الفارغة

1. **المود المصدر:** استخدم موداً أو مجلداً فيه **ملفات INI مفكوكة** (مثل `Data\INI` أو `INI`) حتى تعمل المراجع والتوازن بشكل صحيح.
2. **المود الهدف:** اختر مسار المود الهدف ثم اضغط **تحميل الهدف** حتى تظهر قائمة الفصائل وأماكن الأزرار.
3. **تحويل الفصيل:** اختر وحدة من المصدر ثم افتح «تحويل فصيل الوحدة»؛ التطبيق يقرأ محتوى الوحدة ويعرض المعاينة.
4. **القوالب:** احفظ قالباً من «حفظ قالب جديد» بعد ضبط الاسم والفصيل؛ بعدها ستظهر القوالب في القائمة.

---

## 4. خطة فحص منهجية بعد النقل (لماذا اللعبة لا تعمل)

### 4.1 فحص ملفات INI

- التحقق من وجود تعريفات `Object` للوحدات المنقولة في المود الهدف.
- البحث عن أسطر مكسورة أو مفقودة (مثل `End` ناقص، أو قوس غير مغلق).
- التأكد من أن المراجع (أسلحة، نماذج، أصوات) تشير إلى أصول **موجودة** في المود الهدف.

### 4.2 فحص الأصول (Assets)

- التأكد من نسخ الملفات المرتبطة (`.w3d`, `.wav`, نسيج، إلخ) إلى المسار الصحيح في المود الهدف.
- التحقق من أسماء الملفات في INI وطريقة الإشارة إليها (مسارات نسبية أو أسماء ملفات فقط).

### 4.3 فحص أزرار القيادة (CommandSet)

- التأكد من إضافة الوحدة إلى `CommandSet` للفصيل الصحيح وفي فتحة (Slot) صالحة.
- التحقق من أن الملفات المعدّلة (مثل INI أزرار القيادة) محفوظة ولا تحتوي على تكرار أو تعارض.

### 4.4 فحص التعارضات والأسماء

- تجنب تكرار أسماء الوحدات أو الأسلحة مع وحدات موجودة في المود الهدف ما لم يكن مقصوداً.
- في حالة نقل سلاح: التحقق من أن السلاح مُعرَّف في المود الهدف وأن الوحدات تشير إليه باسم صحيح.

### 4.5 استخدام أدوات الاستوديو

- **الفروقات:** لمقارنة التغييرات بين المصدر والهدف بعد النقل.
- **التشخيص:** تشغيل تشخيص المود إن وُجد في التطبيق.
- **المراجع والتوازن:** بعد التأكد من وجود INI مفكوكة في المصدر للتحقق من اتساق التعريفات.

---

## 5. الثغرات والتحسينات المستقبلية

- **دعم قراءة INI من أرشيفات .big:** حتى تعمل المراجع والتوازن عندما يكون المصدر هو مجلد اللعبة الأصلي دون فك كل الملفات.
- **التحقق التلقائي بعد النقل:** فحص سريع للمراجع المكسورة والأصول الناقصة وإظهار تقرير للمستخدم.
- **استعادة احتياطية:** إمكانية التراجع عن آخر نقل (موجود جزئياً) مع توثيق أوضح وتأكيد آمن.

---

## 6. إعادة بناء المحرك وإصلاح النقل والباتش

### 6.1 ما الذي يُنقل مع الوحدة/السلاح؟

- **SmartDependencyResolver** يبني رسم التبعيات ويضمّن الآن: Weapon, WeaponSet, Projectile, **Upgrade**, **Science**, Armor, Locomotor, FXList, AudioEvent, CommandSet, CommandButton.
- **ترقيات السلاح (Upgrade):** في بعض المودات واللعبة، السلاح يعتمد على ترقية حتى يعمل بعد البناء. تمت إضافة **Upgrade** و **Science** إلى قائمة الأنواع المطلوبة في التحليل، بحيث تُنقل الترقيات والعلوم المرتبطة بالسلاح أو الوحدة مع النقل.
- **WeaponPackageResolver** كان يستخرج الترقيات (Upgrade, UpgradeToGrant, PrerequisiteUpgrade) في حزمة السلاح؛ الرسم الرئيسي للنقل يضمّنها الآن أيضاً عبر SmartDependencyResolver.

راجع المستند **ما_ينتقل_مع_النقل_والباتش.md** للتفاصيل الكاملة.

### 6.2 إصلاحات الكود (محرك النقل والواجهة)

| المكون | الإصلاح |
|--------|---------|
| **SmartDependencyResolver** | إضافة `Upgrade` و `Science` إلى `allowedTypes` في DeepSageChainTraversal حتى تُضمَّن تبعيات الترقيات والعلوم في الرسم وتُنقل مع الوحدة. |
| **Converters (WPF)** | استبدال `NotImplementedException` في ConvertBack بـ `Binding.DoNothing` في HexColorToBrushConverter, SeverityColorConverter, Converters.cs (عدة محولات) لتجنب أي استثناء عند ربط ثنائي الاتجاه بالخطأ. |
| **AdvancedSearchWindow** | توضيح رسائل الأزرار (بحث، إعادة تعيين، تصدير) كـ placeholders وتوجيه المستخدم لاستخدام البحث في لوحة المصدر أو الفروقات. |

### 6.3 الباتش والتوافق مع اللعبة

- **BatchTransferService** يستخدم نفس الـ Pipeline (تحليل تبعيات → نقل → CommandSet → CSF).
- نفس قواعد التبعيات تُطبَّق على كل وحدة في الباتش، بما فيها Upgrade و Science.
- تأكد من **تحميل المود الهدف** قبل تشغيل الباتش حتى تُملأ الفصائل وتكون الأماكن متاحة.

### 6.4 دوال فارغة أو غير مربوطة

- تمت مراجعة الأوامر (Commands) في MainWindow و PortingStudioWindow؛ الأزرار (الفروقات، التوازن، المراجع، القوالب، الفصيل، النقل) مربوطة بأوامر الـ ViewModel.
- **UniversalTransferOrchestrator** يحتوي على TODO لملء unitData من مصدر الوحدة؛ الحالي يعمل مع unitData فارغ والباتر يستخدم قيم افتراضية.

---

تم إعداد هذه الخطة بناءً على تحليل الكود والمشاكل المبلّغ عنها. الإصلاحات المذكورة في الأقسام 2 و 6 تم تنفيذها في الكود؛ التوصيات والأسباب تساعد في فهم سبب الواجهات الفارغة وعدم عمل اللعبة بعد النقل.
