# ما الذي ينتقل مع النقل؟ — دليل كامل للباتش والنقل

## 1. عند نقل **وحدة** ماذا يُنقل؟

المحرك ينقل الوحدة و**كل التبعيات** التي يعثر عليها في الرسم (Dependency Graph):

| النوع | الوصف | أمثلة |
|--------|--------|--------|
| **Object (الوحدة)** | تعريف الوحدة في INI | Object MyUnit ... End |
| **Weapon / WeaponSet** | أسلحة الوحدة | PRIMARY, SECONDARY, TERTIARY |
| **Projectile** | مقذوفات الأسلحة | ProjectileTemplate, ProjectileObject |
| **Upgrade** | ترقيات مرتبطة بالسلاح أو الوحدة | Upgrade = X, UpgradeToGrant, PrerequisiteUpgrade |
| **Science** | علوم مطلوبة أو ممنوحة | Science, GrantScience, PrerequisiteSciences |
| **Armor** | نوع الدروع | ArmorSet |
| **Locomotor** | نوع الحركة | Locomotor |
| **FXList / AudioEvent** | المؤثرات والأصوات | FireFX, Voice, EngineSound |
| **CommandSet / CommandButton** | أزرار القيادة والأيقونات | CommandSet, ButtonImage |
| **ملفات أصول** | نماذج، نسيج، صوت | .w3d, .tga, .dds, .wav |

### ترقيات السلاح (Upgrade) — مهم للمودات المختلفة

- في بعض المودات واللعبة الأصلية، **السلاح يعتمد على ترقية (Upgrade)** حتى يعمل (مثلاً ترقية تفتح السلاح بعد البناء).
- المحرك يضمّن الآن **Upgrade** و **Science** في قائمة الأنواع المطلوبة في تحليل التبعيات.
- لذلك عند نقل وحدة أو سلاح، **الترقيات والعلوم المرتبطة** (من تعريف السلاح أو الوحدة) تُستخرج وتُنقل معها، بحيث يعمل السلاح فور البناء عندما تكون الترقية مضمّنة في المود الهدف.

---

## 2. عند نقل **سلاح** فقط (ضمن وحدة)

عند نقل وحدة تحتوي على سلاح:

1. **السلاح (Weapon)** — تعريف السلاح في INI.
2. **المقذوف (Projectile)** — إن وُجد.
3. **الترقيات (Upgrade)** — مثل `Upgrade = X`, `UpgradeToGrant`, `PrerequisiteUpgrade` من تعريف السلاح.
4. **المؤثرات والأصوات** — FireFX, Sound, إلخ.
5. **ملفات الأصول** — أي .w3d, .wav, نسيج مرتبط بالسلاح أو المقذوف.

كل ما سبق يُستخرج عبر:
- **SmartDependencyResolver** (رسم التبعيات للنقل العادي والباتش).
- **WeaponPackageResolver** (تحليل حزمة السلاح وتبعياته، بما فيها الترقيات في القسم H).

---

## 3. كيف تفحص «إذا نقلت السلاح شو راح ينتقل معه»؟

1. **قبل النقل:**
   - اختر الوحدة في المصدر.
   - استخدم **معاينة الفروقات** أو **الفحص الشامل (Audit)** إن وُجد لعرض التبعيات.
   - في واجهة النقل، يُعرض عدد التبعيات وملخص (مثلاً في نافذة المعاينة قبل تأكيد النقل).

2. **الرسم (Graph):**
   - المحرك يبني `UnitDependencyGraph` ويضمّن:
     - Weapon, WeaponSet, Projectile, **Upgrade**, **Science**, Armor, Locomotor, FXList, AudioEvent, CommandSet, CommandButton.
   - الملفات (ملفات أصول) تُضاف تبعاً للمراجع في التعريفات.

3. **بعد النقل:**
   - استخدم **الفروقات** لمقارنة المصدر بالهدف.
   - تأكد من وجود تعريفات السلاح والترقيات في المود الهدف (مثلاً في Object.ini, Weapon.ini, upgrade.ini).

---

## 4. الباتش (Batch Transfer) والتوافق مع اللعبة

- **BatchTransferService** يستخدم نفس الخط (Pipeline): تحليل تبعيات → كشف تعارضات → نقل ملفات → حقن CommandSet → CSF إن وُجد.
- كل وحدة في الباتش تُنقل مع **نفس قواعد التبعيات** (بما فيها Upgrade و Science).
- لتقليل كسر اللعبة:
  - تجنّب التعارضات الحرجة أو عالجها (إعادة تسمية/تجاوز حسب الخيارات).
  - تأكد من تحميل **المود الهدف** قبل الباتش حتى تُملأ الفصائل والأماكن المتاحة.
  - بعد النقل، راجع الفروقات والتشخيص إن وُجد.

---

## 5. ملخص تقني للمطور

- **SmartDependencyResolver**: `allowedTypes` يضم الآن `Upgrade` و `Science` إضافة إلى Weapon, WeaponSet, Projectile, FXList, Armor, Locomotor, CommandSet, CommandButton.
- **WeaponPackageResolver**: يستخرج تبعيات السلاح بما فيها الترقيات (القسم H) ويضيفها إلى الـ manifest.
- **SmartTransferService**: ينقل كل العقد من الرسم ذات `Status == Found` و`FullPath != null`.
- **TransferPipelineService**: ينفذ التحليل → النقل → حقن CommandSet → CSF.

بهذا يكون النقل والباتش مكتملين من ناحية السلاح والترقيات، ويُفترض أن يعمل السلاح فور البناء عندما تكون الترقيات منقولة ومتوافقة مع المود الهدف.
