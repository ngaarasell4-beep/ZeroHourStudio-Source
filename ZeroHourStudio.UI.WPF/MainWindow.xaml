<Window x:Class="ZeroHourStudio.UI.WPF.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:ZeroHourStudio.UI.WPF"
        xmlns:viewmodels="clr-namespace:ZeroHourStudio.UI.WPF.ViewModels"
        xmlns:conv="clr-namespace:ZeroHourStudio.UI.WPF.Converters"
        mc:Ignorable="d"
        Title="ZeroHour Studio V2" 
        Height="750" Width="1100"
        Background="#1E1E1E"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>
        <conv:ButtonImageToIconConverter x:Key="IconConverter"/>
        <conv:SeverityColorConverter x:Key="SeverityColorConverter"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="#2D2D2D" Padding="15" BorderThickness="0,0,0,1" BorderBrush="#3F3F3F">
            <Grid>
                <TextBlock Text="Zero Hour Studio V2" FontSize="20" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <TextBox Width="250" Height="30" VerticalContentAlignment="Center" Padding="8,0"
                             Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                              Background="#333333" Foreground="White" BorderBrush="#444444"
                              AutomationProperties.Name="بحث الوحدات" AutomationProperties.AutomationId="SearchBox"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Paths -->
        <Border Grid.Row="1" Background="#252525" Padding="12,8" BorderThickness="0,0,0,1" BorderBrush="#3F3F3F">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Row="0" Grid.Column="0" Text="المصدر:" Foreground="#AAAAAA" VerticalAlignment="Center" Margin="0,0,8,4" FontSize="12"/>
                <TextBox Grid.Row="0" Grid.Column="1" Height="28" VerticalContentAlignment="Center" Padding="8,0"
                         Text="{Binding SourceModPath, Mode=TwoWay}" Background="#333333" Foreground="White" BorderBrush="#444444" IsReadOnly="True" Margin="0,0,8,4"
                         AutomationProperties.Name="مسار المود المصدر" AutomationProperties.AutomationId="SourcePath"/>
                <Button Grid.Row="0" Grid.Column="2" Content="استعراض" Padding="15,3" Height="28" Background="#0078D4" Foreground="White" Margin="0,0,0,4" Click="BrowseSourcePath_Click"
                        AutomationProperties.Name="استعراض مسار المصدر" AutomationProperties.AutomationId="BrowseSource"/>

                <TextBlock Grid.Row="1" Grid.Column="0" Text="الهدف:" Foreground="#AAAAAA" VerticalAlignment="Center" Margin="0,0,8,0" FontSize="12"/>
                <TextBox Grid.Row="1" Grid.Column="1" Height="28" VerticalContentAlignment="Center" Padding="8,0"
                         Text="{Binding TargetModPath, Mode=TwoWay}" Background="#333333" Foreground="White" BorderBrush="#444444" IsReadOnly="True" Margin="0,0,8,0"
                         AutomationProperties.Name="مسار المود الهدف" AutomationProperties.AutomationId="TargetPath"/>
                <Button Grid.Row="1" Grid.Column="2" Content="استعراض" Padding="15,3" Height="28" Background="#0078D4" Foreground="White" Click="BrowseTargetPath_Click"
                        AutomationProperties.Name="استعراض مسار الهدف" AutomationProperties.AutomationId="BrowseTarget"/>
            </Grid>
        </Border>

        <!-- Main Content -->
        <Grid Grid.Row="2" Margin="10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="320"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- LEFT: Faction + Unit List -->
            <Border Grid.Column="0" Background="#2D2D2D" CornerRadius="5" Margin="0,0,8,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Faction Filter -->
                    <Border Grid.Row="0" Background="#333333" Padding="10" CornerRadius="5,5,0,0">
                        <StackPanel>
                            <TextBlock Text="اختر الفصيل:" Foreground="#AAAAAA" FontSize="12" Margin="0,0,0,5"/>
                            <ComboBox ItemsSource="{Binding Factions}" SelectedItem="{Binding SelectedFaction}"
                                      Height="30" VerticalContentAlignment="Center" FontSize="13"
                                      Background="#444444" Foreground="White" BorderBrush="#555555"
                                      AutomationProperties.Name="اختيار الفصيل" AutomationProperties.AutomationId="FactionFilter"/>
                        </StackPanel>
                    </Border>

                    <!-- Stats -->
                    <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="10,8,10,5">
                        <TextBlock Text="الوحدات: " Foreground="#888888" FontSize="11"/>
                        <TextBlock Text="{Binding DisplayedUnits.Count}" Foreground="#00CC66" FontSize="11" FontWeight="Bold"/>
                        <TextBlock Text=" / " Foreground="#555555" FontSize="11"/>
                        <TextBlock Text="{Binding Units.Count}" Foreground="#888888" FontSize="11"/>
                    </StackPanel>

                    <!-- Unit List (simple, fast, virtualized) -->
                    <ListBox Grid.Row="2" ItemsSource="{Binding DisplayedUnits}" SelectedItem="{Binding SelectedUnit}"
                             Background="Transparent" BorderThickness="0" Foreground="White" Margin="5,0,5,5"
                             VirtualizingPanel.IsVirtualizing="True"
                             VirtualizingPanel.VirtualizationMode="Recycling"
                              ScrollViewer.IsDeferredScrollingEnabled="True"
                              ScrollViewer.CanContentScroll="True"
                              AutomationProperties.Name="قائمة الوحدات" AutomationProperties.AutomationId="UnitsList">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="AutomationProperties.Name" Value="{Binding TechnicalName}"/>
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="6,4" Margin="1" CornerRadius="3" Background="#3D3D3D">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <Border Grid.Column="0" Width="40" Height="40" CornerRadius="3" Background="#2A2A2A" Margin="0,0,8,0">
                                            <Image Source="{Binding ButtonImage, Converter={StaticResource IconConverter}}" 
                                                   Stretch="Uniform" RenderOptions.BitmapScalingMode="HighQuality"/>
                                        </Border>
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding TechnicalName}" FontSize="12" FontWeight="SemiBold" TextTrimming="CharacterEllipsis" Foreground="White"/>
                                            <TextBlock Text="{Binding Side}" Foreground="#FF6B00" FontSize="10" Margin="0,2,0,0"/>
                                        </StackPanel>
                                        <TextBlock Grid.Column="2" Text="{Binding BuildCost}" Foreground="#00CC66" FontSize="10" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- Load Button -->
                    <Button Grid.Row="3" Content="تحميل المود" Margin="10" Padding="8"
                            Command="{Binding LoadModCommand}" Background="#FF6B00" Foreground="White" FontWeight="Bold"
                            IsEnabled="{Binding HasSourcePath}"
                            AutomationProperties.Name="تحميل المود" AutomationProperties.AutomationId="LoadMod"/>
                </Grid>
            </Border>

            <!-- RIGHT: Details Panel -->
            <Border Grid.Column="1" Background="#2D2D2D" CornerRadius="5">
                <Grid Margin="15">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Unit Name -->
                    <TextBlock Grid.Row="0" Margin="0,0,0,10">
                        <Run Text="{Binding SelectedUnit.TechnicalName, TargetNullValue='اختر وحدة من القائمة', Mode=OneWay}" FontSize="18" FontWeight="Bold" Foreground="White"/>
                        <Run Text=" " />
                        <Run Text="{Binding SelectedUnit.Side, Mode=OneWay}" Foreground="#FF6B00" FontSize="14"/>
                    </TextBlock>

                    <!-- Stats Row -->
                    <Border Grid.Row="1" Padding="12" Background="#3D3D3D" CornerRadius="5" Margin="0,0,0,10">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Foreground="#AAAAAA" FontSize="13">
                                <Run Text="التبعيات: "/><Run Text="{Binding TotalDependencyCount, Mode=OneWay}" Foreground="#0078D4" FontWeight="Bold"/>
                                <Run Text="  |  الأسلحة: "/><Run Text="{Binding WeaponAnalysisCount, Mode=OneWay}" Foreground="#FF6B00" FontWeight="Bold"/>
                                <Run Text="  |  المفقودة: "/><Run Text="{Binding CurrentGraph.MissingCount, TargetNullValue=0, Mode=OneWay}" Foreground="#FF4444" FontWeight="Bold"/>
                                <Run Text="  |  الحالة: "/><Run Text="{Binding CurrentGraph.Status, TargetNullValue=-, Mode=OneWay}" Foreground="#00CC66" FontWeight="Bold"/>
                            </TextBlock>
                            <TextBlock Text="  جاري التحليل..." Foreground="#FFD700" Visibility="{Binding IsAnalyzing, Converter={StaticResource BoolToVisibility}}" FontSize="12"/>
                        </StackPanel>
                    </Border>

                    <!-- Model Info -->
                    <Border Grid.Row="2" Padding="8" Background="#353535" CornerRadius="3" Margin="0,0,0,10">
                        <TextBlock Foreground="#999999" FontSize="11">
                            <Run Text="النموذج: "/><Run Text="{Binding SelectedUnit.ModelW3D, TargetNullValue=-, Mode=OneWay}" Foreground="#CCCCCC"/>
                        </TextBlock>
                    </Border>

                    <!-- Tabs: Dependencies & Diagnostics -->
                    <TabControl Grid.Row="3" Background="Transparent" BorderThickness="0" Margin="0,0,0,10"
                                AutomationProperties.Name="تبويبات التبعيات والتشخيص" AutomationProperties.AutomationId="MainTabs">
                        <TabControl.Resources>
                            <Style TargetType="TabItem">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="TabItem">
                                            <Border Name="Border" BorderThickness="0,0,0,2" BorderBrush="Transparent" Margin="0,0,10,0" Padding="10,5">
                                                <ContentPresenter x:Name="ContentSite" VerticalAlignment="Center" HorizontalAlignment="Center" ContentSource="Header" Margin="0,2"/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsSelected" Value="True">
                                                    <Setter TargetName="Border" Property="BorderBrush" Value="#0078D4"/>
                                                    <Setter Property="Foreground" Value="#0078D4"/>
                                                    <Setter Property="FontWeight" Value="Bold"/>
                                                </Trigger>
                                                <Trigger Property="IsSelected" Value="False">
                                                    <Setter Property="Foreground" Value="#AAAAAA"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </TabControl.Resources>

                        <!-- Tab 1: Dependencies -->
                        <TabItem Header="شجرة التبعيات" AutomationProperties.Name="تبويب شجرة التبعيات" AutomationProperties.AutomationId="DependenciesTab">
                            <DockPanel Margin="0,10,0,0">
                                <TreeView Background="#252525" Foreground="White" BorderBrush="#3F3F3F"
                                          ItemsSource="{Binding CurrentGraph.RootNode.Dependencies}"
                                          VirtualizingPanel.IsVirtualizing="True"
                                          AutomationProperties.Name="شجرة التبعيات" AutomationProperties.AutomationId="DependenciesTree">
                                    <TreeView.ItemTemplate>
                                        <HierarchicalDataTemplate ItemsSource="{Binding Dependencies}">
                                            <StackPanel Orientation="Horizontal" Margin="2">
                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" FontSize="12"/>
                                                <TextBlock Text="{Binding Type, StringFormat=' [{0}]'}" Foreground="#888888" FontSize="11" Margin="4,0,0,0"/>
                                                <TextBlock Foreground="#00CC66" FontSize="10" Margin="6,0,0,0">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Setter Property="Text" Value="✓"/>
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Status}" Value="Missing">
                                                                    <Setter Property="Text" Value="✗"/>
                                                                    <Setter Property="Foreground" Value="#FF4444"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                            </StackPanel>
                                        </HierarchicalDataTemplate>
                                    </TreeView.ItemTemplate>
                                </TreeView>
                            </DockPanel>
                        </TabItem>

                        <!-- Tab 2: Diagnostics -->
                        <TabItem Header="تشخيص الأخطاء" AutomationProperties.Name="تبويب تشخيص الأخطاء" AutomationProperties.AutomationId="DiagnosticsTab">
                            <Grid Margin="0,10,0,0">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <Button Grid.Row="0" Content="بدء الفحص الشامل" Command="{Binding AuditCommand}" 
                                        Background="#333333" Foreground="White" BorderBrush="#555555" Height="30" Margin="0,0,0,10"
                                        AutomationProperties.Name="بدء الفحص الشامل" AutomationProperties.AutomationId="StartAudit"/>

                                <ListView Grid.Row="1" ItemsSource="{Binding AuditIssues}" Background="#252525" Foreground="White" BorderThickness="0"
                                          AutomationProperties.Name="قائمة مشكلات التشخيص" AutomationProperties.AutomationId="AuditIssuesList">
                                    <ListView.View>
                                        <GridView>
                                            <GridViewColumn Header="النوع" Width="80">
                                                <GridViewColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding Severity}" Foreground="{Binding Severity, Converter={StaticResource SeverityColorConverter}}"/>
                                                    </DataTemplate>
                                                </GridViewColumn.CellTemplate>
                                            </GridViewColumn> 
                                            <GridViewColumn Header="الرسالة" Width="300" DisplayMemberBinding="{Binding Message}"/>
                                            <GridViewColumn Header="الموقع" Width="150" DisplayMemberBinding="{Binding Location}"/>
                                            <GridViewColumn Header="الفئة" Width="100" DisplayMemberBinding="{Binding Category}"/>
                                        </GridView>
                                    </ListView.View>
                                </ListView>
                            </Grid>
                        </TabItem>
                    </TabControl>

                    <!-- Actions -->
                    <Grid Grid.Row="4" Margin="0,10,0,0">
                        <ProgressBar Height="6" Value="{Binding ProgressValue}" Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}"
                                     Foreground="#0078D4" Background="#333333" BorderThickness="0" VerticalAlignment="Top"
                                     AutomationProperties.Name="مؤشر التقدم" AutomationProperties.AutomationId="ProgressBar"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,15,0,0">
                            <ComboBox ItemsSource="{Binding TargetFactions}" SelectedItem="{Binding SelectedTargetFaction}"
                                      Width="130" Height="28" VerticalContentAlignment="Center" Background="#333333" Foreground="White" BorderBrush="#444444" Margin="0,0,8,0"
                                      AutomationProperties.Name="فصيل الهدف" AutomationProperties.AutomationId="TargetFactionSelector"/>
                            <Button Content="نقل الوحدة" Padding="20,6" Background="#0078D4" Foreground="White" FontWeight="Bold"
                                    Command="{Binding TransferCommand}"
                                    AutomationProperties.Name="نقل الوحدة" AutomationProperties.AutomationId="TransferUnitButton"/>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="3" Background="#1E1E1E" Padding="10,4" BorderThickness="0,1,0,0" BorderBrush="#3F3F3F">
            <Grid>
                <TextBlock Text="{Binding StatusMessage}" Foreground="#888888" FontSize="10" TextTrimming="CharacterEllipsis"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <TextBlock Foreground="#666666" FontSize="10">
                        <Run Text="الوحدات: "/><Run Text="{Binding Units.Count, Mode=OneWay}" Foreground="#00CC66"/>
                        <Run Text=" | المعروضة: "/><Run Text="{Binding DisplayedUnits.Count, Mode=OneWay}" Foreground="#0078D4"/>
                        <Run Text=" | التحليلات: "/><Run Text="{Binding AnalysisCount, Mode=OneWay}" Foreground="#FF6B00"/>
                    </TextBlock>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>